#! /bin/sh
# Part of USFS.
# Alex Brachet (abrachet@cs.purdue.edu)

usage() {
cat << EOF
Configure script used to build USFS

Usage: ./configure [options]

--help | -h     print this information
--usfs-cleanup  specify the library should be built to free allocated memory on exit
--debug         build for debug
--release       build for release
--libdir=<dir>  specify a lib directory to put usfs.so with make install
--incdir=<dir>  specify an include directory to put header files
--cflag=<flag>  specify a flag to be passed to the compiler
EOF
exit 0
}

exec 3> config.mak

cat 1>&3 << EOF
# This file was auto generated by $0
# Part of USFS.
# Alex Brachet (abrachet@cs.purdue.edu)

EOF

add_to_var() {
    echo "$1 += $2" 1>&3
}

libdir=no
incdir=no
release=false
cleanup=false
debug=false
CFLAGS=
DEFINES=
cc=cc

assert_not_specified() {
    if test ${!1} = true ; then 
        echo --$1 was already specified
        exit 1
    fi
    eval "$1"=true
}

assert_not_set() {
    if test ${!1} != no ; then
        echo --$1 already specified
        exit 1
    fi
}


has_c11() {
    tmpc="./conf$$-$PPID-$i.c"
    echo "typedef int x;" > "$tmpc"
    if $cc --std=c11 -c -o /dev/null "$tmpc" >/dev/null 2>&1 ; then
    rm $tmpc
    return 0
    else
    echo "compiler $cc does not have C11"
    rm $tmpc
    exit 1
    fi
}

for arg ; do
case "$arg" in
--help|-h) usage ;;
--usfs-cleanup) DEFINES="${DEFINES} -DUSFS_CLEANUP"; assert_not_specified cleanup ;;
--debug) CFLAGS="${CFLAGS} -g -fno-builtin"; assert_not_specified debug ;;
--release) CFLAGS="${CFLAGS} -O2"; DEFINES="${DEFINES} -DNDEBUG"; assert_not_specified release ;;
--libdir=*) assert_not_set libdir; libdir=${arg#*=} ;;
--indir=*) assert_not_set incdir; incdir=${arg#*=} ;;
--cflag+=*) CFLAGS="${CFLAGS} ${arg#*=}" ;;
*) echo unkown argument ${*}; exit 1 ;;
esac
done

if has_c11 ; then CFLAGS="${CFLAGS} -std=c11" ; fi

echo CFLAGS += ${CFLAGS} 1>&3
echo DEFINES += ${DEFINES} 1>&3

if test $libdir = no ; then libdir="/usr/local/lib/" ; fi
echo LIBDIR = ${libdir} 1>&3

if test $incdir = no ; then incdir="/usr/local/include/" ; fi
echo INCDIR = ${incdir} 1>&3
